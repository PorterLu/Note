# Sanctum: 软件隔离的最小硬件扩展

## 摘要

​	Sanctum 提供和 Intel SGX一样的保证，为软件提供隔离的保护。Sanctum回避了不必要的复杂性，可以进行更简单的安全分析。我们通过隔离来消除整个攻击面，大多数的Sanctum逻辑都是通过软件实现的，不使用密码学中密钥。我们的原型构建在Rocket-Chip上，Sanctum可以实现在任何其他的处理器上，因为我们已经屏蔽了处理器上的主要模块。同时，我们添加的硬件通过接口层面和其他模块进行连接，不涉及时钟周期的信息。Sanctum证明通过一些小的硬件修改可以在合理的开销内进行软件隔离。

## 介绍

​	今天的系统都依赖操作系统内核或者虚拟机来进行软件隔离。过去三年中每一年都在Linux内核中发现超过一百个新的安全漏洞，在Xen中超过每年40个。一个方法就是通过形式化验证的方法设计一个安全的内核或者虚拟机。不幸的是，这些代码的量级已经超出了形式化验证能接受的量级，Linux和Xen分别有超过1700万行和15万行的代码。形成鲜明对比的是，seL4的形式化验证通过20年验证了9000行代码。

​	考虑Linux和Xen漏洞频出的历史和形式化验证不明朗的前景，一个谨慎的设计者不能将这些纳入到TCB中，而需要寻找其他的软件隔离机制。幸运的是，Intel SGX 在处理器硬件中提供了可替代的软件隔离原语。这条路线很吸引人，因为处理器不可避免地是TCB的一部分，处理器生产商有着很强的经济动力去生产正确的硬件。不幸的是，Intel SGX即使有一系列应对软件和硬件攻击的手段，但它并不能提供软件隔离的保障。SGX威胁模型中，可以防御各种直接的攻击，却防御不了侧信道攻击。更为致命的是，通过我们对于SGX的分析，除了Intel没有任何可以对SGX做安全性分析，因为SGX关键实现的文档并没有对大众开源。这是一个重大隐患，因为在以前Intel尝试远程安全计算，暴露很多Intel处理底层的硬件机制存在很多漏洞。

​	我们的主要贡献就是一种软件隔离方案，可以解决上述提出的问题，Sanctum隔离机制可证明地抵御已知的侧信道漏洞，包括cache测时攻击和被动地址翻译攻击。Sanctum是最小硬件设计和可信任软件security monitor的结合，并且能可控制地进行粗略地进行分析，同时不使用密钥进行密码学计算。我们通过再用，和经过略微修改已知的设计来达到最小化。例如，我们设计的每个enclave一个的机制，使用了每一个处理器都已经存在的page wak机制，同时添加很小的逻辑修改。Sanctum并没有对CPU主要模块进行侵略性的修改，也没有修改任何模块的输入和输出。我们使用传统已经构建好的模块来减少实现Sanctum需要付出的努力。

​	我们证明了Sanctum可以在不引起明显不合理开销的前提下，消灭基于内存访问模式的恶意软件攻击，Sanctum还能实现和其他非安全核一样的时钟频率，因为我们并不修改处理器核的关键路径。因为使用了straightforward page-coloring-based cache分区策略，Sanctum产生了一定比例的硬件开销，但是比ORAM策略的开销小了一个数量级。Sanctum的所有TCB层都是开源的，并不受专利保护、商业机密等因素的拖累，安全人员可以无顾虑地分析它。我们的原型实现在Rocket Chip上。为了进一步地鼓励安全分析，我们所有的Secure Monitor代码都由C++完成，可以在任何处理器实现中使用。更进一步地，不可移植地汇编代码可以在相同架构的不同实现中使用。

## 相关工作

​	Sanctum相对于SGX主要的提升在于阻止了软件通过分析内存访问来获取机密信息。我们特别观测了Cache测时攻击，因为它可以由和受攻击软件同一个计算机的非特权软件发起。Cache测时攻击可以获取AES、RSA、Diffie-Hellman和椭圆曲线密码算法的密钥。早期的攻击需要访问被攻击处理器的处理器核，但是最近的一些复杂的攻击以L3 Cache为目标，同时甚至可以通过浏览器网页内植入Javascript代码进行Cache测时攻击。

​	Cache测时攻击以Cache line为粒度观测受攻击软件的内存访问序列。最近的工作显示，一个恶意操作系统可以通过page fault处理程序记录访问的地址，这样就可以通过页级粒度观测受攻击软件页级的内存访问序列。XOM介绍了在隔离的容器内执行敏感数据和代码的概念，OS管理资源分配，但是不信任它。Aegis依赖于一个受信任的内核来管理不受信任的存储，通过计算容器内软件的哈希值来辨别这个程序，Aegis也在security kernel启动时计算一个哈希值，设用它配合容器的哈希，验证第三方软件，并且获取容器的密钥。不像XOM和Aegis，Sanctum通过在隔离的容器保护软件的内存访问序列来应对软件威胁。

​	Sanctum只关心它的威胁模型里的软件攻击。通过借鉴其他安全架构的设计Sanctum处理器可以抵御物理攻击，但是会增大开销。在DRAM不受信任的情况下，通过内存加密来保护容器内的数据，这项技术也被SGX使用。Ascend和GhostRider使用 Oblivious RAM来保护容器内的存储访问，来保证不在总线上观测到访问的地址。Sanctum的观点时在只考虑软件威胁模型的情况下，不必要引入这些开销。

​	Intel可信执行技术被广泛引用于今天的主流处理器中。当一个恶意的OS导致网卡访问了受保护的虚拟机内的数据，Intel可信执行技术修改了DRAM控制器来选择性阻塞DMA传送，这项工作Sanctum也有实现。Intel SGX使用了Aegis和XOM的想法，多个处理器核使用同一个共享的、一致的LLC。Sanctum也使用了这个想法，来进行内存访问控制，使得设计不会改变CPU的关键路径。我们逆向工程并且接受SGX中OS进行TLB击落的做法。同时，Sanctum解决在Introduction中介绍的SGX的多个问题。

​	Iso-X尝试为SGX提供安全保证，不去使用SGX开机专门为enclaves创建的内存空间，Iso-X也需要像Sanctum一样为每个enclave一个的页表，但是Iso-X需要一个专门的page walker，同时增大时钟周期，并且不能抵御Cache测时攻击。SecureME也提出一种对于硬件和trusted虚拟机的修改，来确保软件的隔离抵御恶意的OS，而片上系统修改往往是为了抵御物理攻击、但是就像SGX, SecureME在内存访问序列攻击面前是脆弱的。

​	学术界已经提出了多个抵御Cache测时攻击的方法，PLcache和Random Fill Cache体系结构在小范围的敏感数据上进行了分析，并且将其推广到一个将达enclave的程序，但是性能有没有损失，只不过这种方法并不直接。但将整个enclave放在L3 Cache时，RFill性能损耗将达到37%-66%。

​	RPcache信任OS来分配不同的硬件进程ID给互不信任的实体，但是这种方案并不适用于扩大到LLC的情况。不可独占的cache设计了一种很好的组织策略，但是并能阻止信息泄露，同时信任OS来分配硬件ID。CATalyst信任Xen虚拟机来正确控制Intel Cache分配技术来提供cache绑定，但是这只适用于数据代码可以符合LLC的片段的情况。

​	Sanctum使用一种简单的基于page染色的cache分区机制，可以证明这种机制的开销是合理的，可以配合ZCache和Vantage来实现更好的性能。

​	



​	

​	

